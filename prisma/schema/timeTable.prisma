enum TimetableOverrideType {
  SUBSTITUTE
  CANCELLED
}

model TimePeriod {
  id       Int @id @default(autoincrement())
  schoolId Int

  name      String // P1, P2, Assembly
  startTime String // "09:00"
  endTime   String // "09:45"

  createdAt DateTime @default(now())

  school    School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  entries   TimetableEntry[]
  timeSlots TimeSlot[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model TimetableEntry {
  id Int @id @default(autoincrement())

  // Tenant & academic isolation
  schoolId       Int
  academicYearId Int

  // Academic mapping
  classId   Int
  sectionId Int
  subjectId Int
  teacherId Int

  // Time
  day      DayOfWeek
  periodId Int

  // Optional room
  roomId Int?

  isFixed Boolean @default(false) // assembly, lunch

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear       AcademicYear        @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  class              Class               @relation(fields: [classId], references: [id], onDelete: Cascade)
  section            Section             @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subject            Subject             @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher            TeacherProfile      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  period             TimePeriod          @relation(fields: [periodId], references: [id], onDelete: Cascade)
  room               Room?               @relation(fields: [roomId], references: [id], onDelete: SetNull)
  timeSlot           TimeSlot?           @relation(fields: [timeSlotId], references: [id])
  timeSlotId         Int?
  timetableOverrides TimetableOverride[]

  // Prevent obvious duplicates only
  @@unique([schoolId, academicYearId, sectionId, day, periodId])
  @@index([teacherId])
  @@index([roomId])
}

model TimetableOverride {
  id Int @id @default(autoincrement())

  schoolId       Int
  academicYearId Int
  entryId        Int
  date           DateTime

  type TimetableOverrideType

  substituteTeacherId Int?
  substituteRoomId    Int?
  note                String?

  createdById Int?
  createdAt   DateTime @default(now())

  entry             TimetableEntry  @relation(fields: [entryId], references: [id], onDelete: Cascade)
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  substituteTeacher TeacherProfile? @relation(fields: [substituteTeacherId], references: [id])
  substituteRoom    Room?           @relation(fields: [substituteRoomId], references: [id])
  createdBy         User?           @relation(fields: [createdById], references: [id])

  @@index([schoolId, date])
}
