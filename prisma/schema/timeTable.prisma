enum TimetableOverrideType {
  SUBSTITUTE
  CANCELLED
}

enum PeriodType {
  TEACHING
  BREAK
  ASSEMBLY
}

enum TimetableStatus {
  DRAFT
  PUBLISHED
  LOCKED
}

model Schedule {
  id             Int @id @default(autoincrement())
  schoolId       Int
  academicYearId Int

  name        String // "Primary Schedule", "Senior Schedule", "Exam Schedule"
  description String?
  isDefault   Boolean @default(false)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timePeriods TimePeriod[]
  classes     Class[]

  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([schoolId, academicYearId, name])
  @@index([schoolId, academicYearId])
  @@map("schedules")
}

model TimePeriod {
  id             Int  @id @default(autoincrement())
  schoolId       Int
  academicYearId Int
  scheduleId     Int?

  name      String // P1, P2, Assembly
  startTime String // "09:00"
  endTime   String // "09:45"

  type PeriodType  @default(TEACHING)
  days DayOfWeek[] // Applicable days for this period

  createdAt DateTime @default(now())

  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear       AcademicYear        @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  schedule           Schedule?           @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  entries            TimetableEntry[]
  timeSlots          TimeSlot[]
  attendanceSessions AttendanceSession[]

  @@unique([schoolId, academicYearId, scheduleId, name])
  @@index([schoolId])
}

model TimetableEntry {
  id Int @id @default(autoincrement())

  // Tenant & academic isolation
  schoolId       Int
  academicYearId Int

  // Academic mapping
  classId   Int
  sectionId Int
  subjectId Int
  teacherId Int

  // Time
  day      DayOfWeek
  periodId Int

  // Optional room
  roomId Int?

  // Workflow & Locking
  isLocked    Boolean         @default(false)
  status      TimetableStatus @default(DRAFT)
  publishedAt DateTime?
  publishedBy Int?

  isFixed Boolean @default(false) // assembly, lunch

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear       AcademicYear        @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  class              Class               @relation(fields: [classId], references: [id], onDelete: Cascade)
  section            Section             @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subject            Subject             @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher            TeacherProfile      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  period             TimePeriod          @relation(fields: [periodId], references: [id], onDelete: Cascade)
  room               Room?               @relation(fields: [roomId], references: [id], onDelete: SetNull)
  timeSlot           TimeSlot?           @relation(fields: [timeSlotId], references: [id])
  timeSlotId         Int?
  publisher          User?               @relation("TimetablePublisher", fields: [publishedBy], references: [id], onDelete: SetNull)
  timetableOverrides TimetableOverride[]

  // Prevent double booking
  @@unique([schoolId, academicYearId, sectionId, day, periodId]) // Section cannot be in two places
  @@unique([schoolId, academicYearId, teacherId, day, periodId]) // Teacher cannot be in two places
  @@unique([schoolId, academicYearId, roomId, day, periodId]) // Room cannot be double booked
  @@index([teacherId])
  @@index([roomId])
}

model TimetableOverride {
  id Int @id @default(autoincrement())

  schoolId       Int
  academicYearId Int
  entryId        Int
  date           DateTime

  type TimetableOverrideType

  substituteTeacherId Int?
  substituteRoomId    Int?
  note                String?

  createdById Int?
  createdAt   DateTime @default(now())

  entry             TimetableEntry  @relation(fields: [entryId], references: [id], onDelete: Cascade)
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  substituteTeacher TeacherProfile? @relation(fields: [substituteTeacherId], references: [id])
  substituteRoom    Room?           @relation(fields: [substituteRoomId], references: [id])
  createdBy         User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([schoolId, entryId, date])
  @@index([schoolId, date])
}
